Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length>>>0,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=b);b>c;c++)if(c in this&&this[c]===a)return c;return-1}),function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),MediumEditor=Class.extend({}),MediumEditor.BUILT_IN_EVENTS=["blur","change","click","contextmenu","copy","cut","dblclick","error","focus","focusin","focusout","hashchange","keydown","keypress","keyup","load","mousedown","mousecenter","mouseleave","mousemove","mouseout","mouseover","mouseup","mousewheel","paste","reset","resize","scroll","select","submit","unload","wheel"],MediumEditor.MVC=Class.extend({on:function(a,b,c){"function"==typeof b&&(c=b,b=this);for(var d=a.split(" "),e=0;e<d.length;e++)a=d[e].toLowerCase(),MediumEditor.BUILT_IN_EVENTS.indexOf(a)>=0?b.addEventListener?b.addEventListener(a,c,!1):b.attachEvent&&(b["e"+a+c]=c,b[a+c]=function(){b["e"+a+c](window.event)},b.attachEvent("on"+a,b[a+c])):(b.eventListeners||(b.eventListeners={}),b.eventListeners.hasOwnProperty(a)||(b.eventListeners[a]=[]),b.eventListeners[a].push(c))},trigger:function(a){a=a.toLowerCase(),this.eventListeners||(this.eventListeners={});var b=Array.prototype.slice.call(arguments,1);if(this.eventListeners.hasOwnProperty(a))for(var c=this.eventListeners[a],d=0;d<c.length;d++)c[d].apply(this,b)},el:function(){return this._el}}),MediumEditor.Model=MediumEditor.MVC.extend({init:function(){}}),MediumEditor.Collection=MediumEditor.MVC.extend({init:function(){this._items=[]},add:function(a){this.insertAt(a,this.size())},insertAt:function(a,b){this._items.splice(b,0,a),this.trigger("add",a,b)},size:function(){return this._items.length},at:function(a){return this._items[a]},remove:function(a){var b=this._items.indexOf(a);b>=0&&this.removeAt(b)},removeAt:function(a){var b=this.at(a);this._items.splice(a,1),this.trigger("remove",b,a)},clear:function(){this._items=[]},indexOf:function(a){return this._items.indexOf(a)}}),MediumEditor.View=MediumEditor.MVC.extend({init:function(a){if(!a.model)throw"Medium Editor views require a model";this._model=a.model},on:function(a,b,c){"function"==typeof b&&(c=b,b=this._el),this._super(a,b,c)},model:function(){return this._model}}),MediumEditor.ModelDOMMapper={parseHTMLIntoBlockCollection:function(a){var b=new MediumEditor.BlockCollection({model:a.document}),c=document.createElement("div");c.innerHTML=a.html.trim();for(var d=0;d<c.children.length;d++)for(var e=c.children[d],f=e.className.substring(7).toUpperCase(),g=0;g<e.children.length;g++){var h=e.children[g],i=h.tagName.toLowerCase();if("ol"==i||"ul"==i)for(var j=0;j<h.children.length;j++){var k=h.children[j];b.add(this._parseNodeIntoBlock(k,f))}else b.add(this._parseNodeIntoBlock(h,f))}return b},_parseNodeIntoBlock:function(a,b){b=a.className||b;var c={text:a.innerText,layout:b},d=a.tagName.toLowerCase();switch(d){case"p":c.type="PARAGRAPH";break;case"blockquote":c.type="QUOTE";break;case"h2":c.type="HEADING1";break;case"h3":c.type="HEADING2";break;case"h4":c.type="HEADING3";break;case"hr":c.type="DIVIDER";break;case"figure":c.type="img"==a.children[0].tagName.toLowerCase()?"IMAGE":"VIDEO",c.metadata={},c.metadata.src=a.children[0].src,a.children.length>1&&(c.metadata.caption=a.children[1].innerText);break;case"li":c.type="ol"==a.parentNode.tagName.toLowerCase()?"ORDERED_LIST_ITEM":"UNORDERED_LIST_ITEM"}return new MediumEditor.BlockModel(c)},toHTML:function(a,b){if(b="undefined"==typeof b?{}:b,b["for"]="undefined"==typeof b["for"]?"editing":b["for"],a instanceof MediumEditor.BlockModel){var c;switch(!0){case a.isParagraph():c="p";break;case a.isQuote():c="blockquote";break;case a.isHeading1():c="h2";break;case a.isHeading2():c="h3";break;case a.isHeading3():c="h4";break;case a.isImage():c="figure";break;case a.isVideo():c="figure";break;case a.isOrderedListItem():c="li";break;case a.isUnorderedListItem():c="li";break;case a.isDivider():c="div"}var d="<"+c+(a.isText()||"editing"!=b["for"]?"":' contenteditable="false"')+("class"==this._layoutType(a.layout())?' class="'+a.layout().toLowerCase()+'"':"")+">",e="</"+c+">",f=d+this._innerHTML(a,b)+e;return f}if(a instanceof MediumEditor.DocumentModel){for(var g=a.blocks(),h="",i=null,j=0;j<g.size();j++){var k=j>0?g.at(j-1):null,l=g.at(j),m=j<g.size()-1?g.at(j+1):null;(null==k||"wrapper"==this._layoutType(l.layout())&&i!=l.layout())&&(h+="<div class='layout-"+l.layout().toLowerCase()+"'>",i=l.layout()),l.isListItem()&&(null==k||k.type()!=l.type())&&(h+="<"+(l.isOrderedListItem()?"ol":"ul")+">"),h+=this.toHTML(g.at(j)),l.isListItem()&&(null==m||m.type()!=l.type())&&(h+="</"+(l.isOrderedListItem()?"ol":"ul")+">"),(null==m||"wrapper"==this._layoutType(m.layout())&&i!=m.layout())&&(h+="</div>")}return h}},_innerHTML:function(a,b){if(a.isText()){var c=this.markup(a)||"<br>";return c.replace(/\s{2}/g," &nbsp;").replace(/^ /,"&nbsp;").replace(/ $/,"&nbsp;")}if(a.isMedia()){var c;return c=a.isImage()?"<img src='"+a.metadata().src+"'>":"<iframe frameborder='0' allowfullscreen src='"+a.metadata().src+"'>",a.metadata().caption&&(c+="<figcaption "+("editing"==b["for"]?"contenteditable='true'":"")+">"+a.metadata().caption+"</figcaption>"),c}return"<hr>"},markup:function(a){var b=a.text(),c=a.markups();if(0==c.size())return b;for(var d=[],e=0;e<c.size();e++){var f=c.at(e);d.push({type:"open",at:f.start(),tag:this._tag(f),obj:f}),d.push({type:"close",at:f.end(),tag:this._tag(f),obj:f})}d.sort(function(a,b){if(a.at!=b.at)return a.at-b.at;if(a.type[0]!=b.type[0])return this._charComparison(a.type[0],b.type[0]);var c="open"==a.type?1:-1;return this._charComparison(a.tag[0],b.tag[0])*c}.bind(this));for(var g="",h=0,i=[],e=0;e<d.length;e++){var j=d[e];if(g+=b.substring(h,j.at),h=j.at,"open"==j.type)g+=this._openingTag(j.obj),i.push(j);else{for(var k,l=[];(k=i.pop()).tag!=j.tag;)l.push(k);for(var m=0;m<l.length;m++)g+=this._closingTag(l[m].obj);for(g+=this._closingTag(j.obj);l.length;){var n=l.pop();g+=this._openingTag(n.obj),i.push(n)}}}return g+=b.substring(h)},_charComparison:function(a,b){return b>a?-1:a>b?1:0},_layoutType:function(a){return"SINGLE-COLUMN"==a||"FULL-WIDTH"==a?"wrapper":"class"},_openingTag:function(a){return"<"+this._tag(a)+" "+this._openingTagAttributes(a)+">"},_closingTag:function(a){return"</"+this._tag(a)+">"},_tag:function(a){switch(!0){case a.isStrong():return"strong";case a.isEmphasis():return"em";case a.isAnchor():return"a"}},_openingTagAttributes:function(a){switch(!0){case a.isAnchor():return'href="'+a.href+'"'}return""},modelSpaceToDOMSpace:function(a,b,c){for(var d=this.getBlockElementFromIndex(a,b),e=this._getTextNodesIn(d),f=0;f<e.length;f++){var g=e[f];if(c<=g.length)return{node:g,offset:c};c-=g.length}return{node:d.childNodes[0],offset:Math.min((d.childNodes[0].nodeValue||d.childNodes[0].innerText).length,c)}},getBlockElementFromIndex:function(a,b){for(var c=0;c<a.children.length;c++)for(var d=a.childNodes[c],e=0;e<d.children.length;e++){var f=d.children[e];if("ol"==f.tagName.toLowerCase()||"ul"==f.tagName.toLowerCase()){if(b<f.childNodes.length)return f.childNodes[b];b-=f.childNodes.length}else b--;if(0>b)return f}return null},_getTextNodesIn:function(a){var b=[];if(3==a.nodeType)b.push(a);else for(var c=a.childNodes,d=0;d<c.length;d++)b.push.apply(b,this._getTextNodesIn(c[d]));return b},domSpaceToModelSpace:function(a,b,c,d){var e=this._blockElementFromNode(a),f=this.getIndexFromBlockElement(e),b=this._measureTextOffset(b,a,e,c,d);return{ix:f,offset:b}},_blockElementFromNode:function(a){for(;"div"!=a.parentNode.tagName.toLowerCase()&&"ol"!=a.parentNode.tagName.toLowerCase()&&"ul"!=a.parentNode.tagName.toLowerCase();)if(a=a.parentNode,a.parentNode==document.body)return null;return a},getIndexFromBlockElement:function(a){var b=a;"li"==a.tagName.toLowerCase()&&(b=b.parentNode),b=b.parentNode.parentNode;for(var c=0,d=0;d<b.children.length;d++)for(var e=b.children[d],f=0;f<e.children.length;f++){var g=e.children[f];if("ul"==g.tagName.toLowerCase()||"ol"==g.tagName.toLowerCase())for(var h=0;h<g.children.length;h++){var i=g.children[h];if(i==a)return c;c+=1}else{if(g==a)return c;c+=1}}},_numBlockElementsWithin:function(a){for(var b=0,c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];"ol"==d.tagName.toLowerCase()||"ul"==d.tagName.toLowerCase()?b+=d.childNodes.length:b++}return b},_measureTextOffset:function(a,b,c,d,e){if(window.getSelection){var f=d.cloneRange();return f.selectNodeContents(c),f.setEnd(b,a),f.toString().length}if(document.selection){var f=doc.body.createTextRange();return f.moveToElementText(c),f.setEndPoint(e?"StartToEnd":"EndToEnd",d),f.text.length}}},MediumEditor.DocumentModel=MediumEditor.Model.extend({init:function(a){this._super(a),this._blocks=MediumEditor.ModelDOMMapper.parseHTMLIntoBlockCollection({document:this,html:a.html||"<p></p>"});for(var b=0;b<this._blocks.size();b++)this.on("changed",this._blocks.at(b),this._onBlockChanged.bind(this))},_onBlockChanged:function(){this.trigger("changed")},blocks:function(){return this._blocks},isBlank:function(){return 1==this._blocks.size()&&""==this._blocks.at(0).text()},removeBlockAt:function(a){this._blocks.removeAt(a),this.trigger("changed")},insertBlockAt:function(a,b,c){c="undefined"==typeof c?{}:c,c.type=a;var d=new MediumEditor.BlockModel(c);this.on("changed",d,this._onBlockChanged.bind(this)),this._blocks.insertAt(d,b),this.trigger("changed")},toggleMarkup:function(a,b){for(var c=b._startIx;c<=b._endIx;c++){var d=this._blocks.at(c),e=c==b.startIx()?b.startOffset():0,f=c==b.endIx()?b.endOffset():d.text().length;d.markup(e,f,a,{silent:!0})}this.trigger("changed")},setType:function(a,b){for(var c=b._startIx;c<=b._endIx;c++){var d=this._blocks.at(c);d.setType(a,{silent:!0})}this.trigger("changed")},setLayout:function(a,b){for(var c=b._startIx;c<=b._endIx;c++){var d=this._blocks.at(c);d.setLayout(a,{silent:!0})}this.trigger("changed")}}),MediumEditor.BlockModel=MediumEditor.Model.extend({init:function(a){this._super(a),this._setAttributes(a)},isParagraph:function(){return"PARAGRAPH"==this._type},isQuote:function(){return"QUOTE"==this._type},isHeading1:function(){return"HEADING1"==this._type},isHeading2:function(){return"HEADING2"==this._type},isHeading3:function(){return"HEADING3"==this._type},isHeading:function(){return this.isHeading1()||this.isHeading2()||this.isHeading3()},isOrderedListItem:function(){return"ORDERED_LIST_ITEM"==this._type},isUnorderedListItem:function(){return"UNORDERED_LIST_ITEM"==this._type},isDivider:function(){return"DIVIDER"==this._type},isImage:function(){return"IMAGE"==this._type},isVideo:function(){return"VIDEO"==this._type},isText:function(){return this.isParagraph()||this.isQuote()||this.isHeading()||this.isListItem()},isMedia:function(){return this.isImage()||this.isVideo()},isListItem:function(){return this.isOrderedListItem()||this.isUnorderedListItem()},type:function(){return this._type},text:function(){return this._text},layout:function(){return this._layout},markups:function(){return this._markups},metadata:function(){return this._metadata},isEmpty:function(){return this.isText()&&""==this._text},supportsMarkupType:function(a){switch(a){case"STRONG":case"EMPHASIS":return this.isText()&&!this.isHeading();case"ANCHOR":return this.isText()}},supportsLayout:function(){return this.isMedia()||this.isQuote()},supportsMetadata:function(){return this.isMedia()},isRangeMarkedUpAs:function(a,b,c){return this._markups&&this._markups.isRangeMarkedUpAs(a,b,c)},setType:function(a,b,c){if(this._type!=a){var d={type:a,text:this._text};for(var e in b)d[e]=b[e];this._setAttributes(d),c&&c.silent||this.trigger("changed")}},setText:function(a){this._text!=a&&(this._text=a,this.trigger("changed"))},setLayout:function(a,b){this._layout!=a&&(this._layout=a,b&&b.silent||this.trigger("changed"))},markup:function(a,b,c,d){this.supportsMarkupType(c)&&(this._markups.add(new MediumEditor.MarkupModel({type:c,start:a,end:b})),d&&d.silent||this.trigger("changed"))},setMetadata:function(a,b){this._metadata[a]!=b&&(this._metadata[a]=b,this.trigger("changed"))},_setAttributes:function(a){this._type=a.type||"PARAGRAPH",this._text=this.isText()?a.text||"":null,this._layout=this.supportsLayout()?a.layout||"SINGLE-COLUMN":"SINGLE-COLUMN",this._markups=this.isText()?new MediumEditor.MarkupCollection:null,this._metadata=this.supportsMetadata()?a.metadata||{}:null}}),MediumEditor.MarkupModel=MediumEditor.Model.extend({init:function(a){this._super(a),this._setAttributes(a)},isStrong:function(){return"STRONG"==this._type},isEmphasis:function(){return"EMPHASIS"==this._type},isAnchor:function(){return"ANCHOR"==this._type},type:function(){return this._type},start:function(){return this._start},end:function(){return this._end},metadata:function(){return this._metadata},touches:function(a){return this._start<=a._end&&this._end>=a._start},covers:function(a){return this._start<=a._start&&this._end>=a._end},supportsMetadata:function(){return this.isAnchor()},setStart:function(a){this._start=a,this.trigger("changed")},setEnd:function(a){this._end=a,this.trigger("changed")},setMetadata:function(a,b){this._metadata[a]!=b&&(this._metadata[a]=b,this.trigger("changed"))},_setAttributes:function(a){if(this._type=a.type||"STRONG",this._start=a.start||0,this._end=a.end||0,this._metadata=this.supportsMetadata()?a.metadata||{}:null,this._start>this._end){var b=this._end;this._end=this._start,this._start=b}if(this._start==this._end)throw"Start and end points of markup must be separate"}}),MediumEditor.SelectionModel=MediumEditor.Model.extend({init:function(a){this._super(a),this._setAttributes(a),this._determineType()},isNull:function(){return"NULL"==this._type},isCaret:function(){return"CARET"==this._type},isRange:function(){return"RANGE"==this._type},isMedia:function(){return"MEDIA"==this._type},type:function(){return this._type},startIx:function(){return this._startIx},endIx:function(){return this._endIx},startOffset:function(){return this._startOffset},endOffset:function(){return this._endOffset},startBlock:function(){return this.isNull()?null:this._document.blocks().at(this._startIx)},endBlock:function(){return this.isNull()?null:this._document.blocks().at(this._endIx)},withinOneBlock:function(){return this._startIx==this._endIx},spansBlocks:function(){return!this.withinOneBlock()},"null":function(){this._setAttributes({})},media:function(a){this.caret(a,0)},caret:function(a,b){this._setAttributes({startIx:a,startOffset:b,endIx:a,endOffset:b})},set:function(a,b){this._setAttributes(a,b)},_setAttributes:function(a,b){"undefined"==typeof b&&(b={}),"undefined"==typeof b.triggerEvent&&(b.triggerEvent=!0),(a.startIx!=this._startIx||a.startOffset!=this._startOffset||a.endIx!=this._endIx||a.endOffset!=this._endOffset)&&(this._startIx=a.startIx,this._startOffset=a.startOffset,this._endIx=a.endIx,this._endOffset=a.endOffset,this._determineType(),b.triggerEvent&&this.trigger("changed",this,b.caller)),a.document&&(this._document=a.document)},_determineType:function(){this._type=void 0===this._startIx?"NULL":0==this._startOffset&&this._document.blocks().at(this._startIx).isMedia()?"MEDIA":this._startIx==this._endIx&&this._startOffset==this._endOffset?"CARET":"RANGE"}}),MediumEditor.BlockCollection=MediumEditor.Collection.extend({init:function(a){this._super(a)}}),MediumEditor.MarkupCollection=MediumEditor.Collection.extend({init:function(a){this._super(a)},add:function(a){var b=this._otherItemsOfSameType(a);b.sort(function(a,b){return a.start()-b.start()});for(var c=0;c<b.length;c++){var d=b[c];if(d.covers(a))return void this._toggle(d,a);d.touches(a)&&(a.isAnchor()&&a.metadata().href!=d.metadata().href?a.covers(d)?this.remove(d):(d.setStart(Math.max(d.start(),a.end())),d.setEnd(Math.min(d.end(),a.start()))):(a.setStart(Math.min(d.start(),a.start())),a.setEnd(Math.max(d.end(),a.end())),this.remove(d)))}this._super(a)},isRangeMarkedUpAs:function(a,b,c){for(var d=this._itemsOfType(a),e=0;e<d.length;e++){var f=d[e];if(f.isAnchor()){if(f.start()<=b){if(f.end()>=c)return!0;b=f.end()}}else if(f.start()<=b&&f.end()>=c)return!0}return!1},_otherItemsOfSameType:function(a){var b=this._itemsOfType(a.type()),c=b.indexOf(a);return c>=0&&b.splice(c,1),b},_itemsOfType:function(a){for(var b=[],c=0;c<this.size();c++){var d=this.at(c);d.type()==a&&b.push(d)}return b},_toggle:function(a,b){if(a.covers(b)){var c=a.start(),d=b.start(),e=b.end(),f=a.end();c==d&&e==f?this.remove(a):c==d?a.setStart(e):e==f?a.setEnd(d):(a.setEnd(d),this.add(new MediumEditor.MarkupModel({type:b.type(),start:e,end:f}))),b.isAnchor()&&b.metadata().href==a.metadata().href&&this.add(b)}}}),MediumEditor.InlineTooltipMenuView=MediumEditor.View.extend({BUTTONS:{toggle:'<i class="ion-ios-plus-empty"></i>',image:'<i class="ion-ios-camera-outline"></i>',divider:'<i class="ion-ios-minus-empty"></i>'},CLASS_NAME:"medium-editor-inline-tooltip",ACTIVE_CLASS_NAME:"medium-editor-inline-tooltip-active",OPEN_CLASS_NAME:"medium-editor-inline-tooltip-open",TOGGLE_CLASS_NAME:"medium-editor-inline-tooltip-toggle",BUTTON_SET_CLASS_NAME:"medium-editor-inline-tooltip-button-set",init:function(a){this._super(a),this._editor=a.editor,this.on("changed",this._selection().model(),this._onSelectionChanged.bind(this)),this._render()},_onSelectionChanged:function(){var a=this._selection().model(),b=a.startBlock();a.isCaret()&&b.isParagraph()&&b.isEmpty()?this._showAndPosition():this._hide()},_render:function(){this._el=document.createElement("div"),this._el.className=this.CLASS_NAME;var a=document.createElement("button");a.type="button",a.className=this.TOGGLE_CLASS_NAME,a.innerHTML=this.BUTTONS.toggle,this.on("click",a,this._toggle.bind(this)),this._el.appendChild(a);var b=document.createElement("div");b.className=this.BUTTON_SET_CLASS_NAME,this._el.appendChild(b);for(var c in this.BUTTONS)if(this.BUTTONS.hasOwnProperty(c)&&"toggle"!=c){var d=document.createElement("button");d.type="button",d.innerHTML=this.BUTTONS[c],d.setAttribute("data-action",c),this.on("click",d,this._onButton.bind(this)),b.appendChild(d)}},_showAndPosition:function(){var a=this._selection().rectangle();this._el.style.top=a.top+"px",this._el.style.left=a.left+"px",this._el.className=[this.CLASS_NAME,this.ACTIVE_CLASS_NAME].join(" ")},_toggle:function(){var a=[this.CLASS_NAME,this.ACTIVE_CLASS_NAME];this._el.className.indexOf(this.OPEN_CLASS_NAME)<0&&a.push(this.OPEN_CLASS_NAME),this._el.className=a.join(" ")},_onButton:function(a){var b=a.currentTarget.getAttribute("data-action"),c=this._selection().model();switch(b){case"image":this._insertImage();break;case"video":break;case"divider":c.startBlock().setType("DIVIDER"),c.caret(c._startIx+1,0)}},_insertImage:function(){var a=document.createElement("input");a.type="file",this.on("change",a,function(){if(a.files&&a.files[0]){var b=new FileReader;b.onload=function(a){this._selection().model().startBlock().setType("IMAGE",{metadata:{src:a.target.result}})}.bind(this),b.readAsDataURL(a.files[0])}}.bind(this));var b=document.createEvent("Events");b.initEvent("click",!0,!1),a.dispatchEvent(b)},_hide:function(){this._el.className=this.CLASS_NAME},_selection:function(){return this._editor.selection()}}),MediumEditor.HighlightMenuView=MediumEditor.View.extend({CLASS_NAME:"medium-editor-highlight-menu",ACTIVE_CLASS_NAME:"medium-editor-highlight-menu-active",POSITION_UNDER_CLASS_NAME:"medium-editor-highlight-menu-under",BUTTON_ACTIVE_CLASS_NAME:"medium-editor-highlight-menu-button-active",BUTTONS:{STRONG:{buttonHTML:function(){return"B"},isVisible:function(){return this._allBlocksSupportMarkup("STRONG")},buttonClass:function(){return this._markedUpAs("STRONG")?this.BUTTON_ACTIVE_CLASS_NAME:null},onClick:function(){this._model.toggleMarkup("STRONG",this._selectionModel())}},EMPHASIS:{buttonHTML:function(){return"i"},isVisible:function(){return this._allBlocksSupportMarkup("EMPHASIS")},buttonClass:function(){return this._markedUpAs("EMPHASIS")?this.BUTTON_ACTIVE_CLASS_NAME:null},onClick:function(){this._model.toggleMarkup("EMPHASIS",this._selectionModel())}},HEADING1:{buttonHTML:function(){return"H1"},isVisible:function(){return this._noMediaBlocks()},buttonClass:function(){return this._allBlocksAre("HEADING1")?this.BUTTON_ACTIVE_CLASS_NAME:null},onClick:function(){this._allBlocksAre("HEADING1")?this._model.setType("PARAGRAPH",this._selectionModel()):this._model.setType("HEADING1",this._selectionModel())}},HEADING2:{buttonHTML:function(){return"H2"},isVisible:function(){return this._noMediaBlocks()},buttonClass:function(){return this._allBlocksAre("HEADING2")?this.BUTTON_ACTIVE_CLASS_NAME:null},onClick:function(){this._allBlocksAre("HEADING2")?this._model.setType("PARAGRAPH",this._selectionModel()):this._model.setType("HEADING2",this._selectionModel())}},HEADING3:{buttonHTML:function(){return"H3"},isVisible:function(){return this._noMediaBlocks()},buttonClass:function(){return this._allBlocksAre("HEADING3")?this.BUTTON_ACTIVE_CLASS_NAME:null},onClick:function(){this._allBlocksAre("HEADING3")?this._model.setType("PARAGRAPH",this._selectionModel()):this._model.setType("HEADING3",this._selectionModel())}},QUOTE:{buttonHTML:function(){return"â€œ"},isVisible:function(){return this._noMediaBlocks()},buttonClass:function(){return this._allBlockQuotes()?this.BUTTON_ACTIVE_CLASS_NAME:this._allPullQuotes()?this.BUTTON_ACTIVE_CLASS_NAME+" medium-editor-highlight-menu-button-pull-quote":null},onClick:function(){this._allBlockQuotes()?this._model.setLayout("PULL-QUOTE",this._selectionModel()):this._allPullQuotes()?this._model.setType("PARAGRAPH",this._selectionModel()):this._model.setType("QUOTE",this._selectionModel())}},"LEFT-ALIGN":{buttonHTML:function(){return"L"},isVisible:function(){return this._allMediaBlocks()},buttonClass:function(){return this._allLayoutsAre("LEFT-ALIGN")?this.BUTTON_ACTIVE_CLASS_NAME:null},onClick:function(){this._model.setLayout("LEFT-ALIGN",this._selectionModel())}},"LEFT-OUTSET":{buttonHTML:function(){return"LO"},isVisible:function(){return this._allMediaBlocks()},buttonClass:function(){return this._allLayoutsAre("LEFT-OUTSET")?this.BUTTON_ACTIVE_CLASS_NAME:null},onClick:function(){this._model.setLayout("LEFT-OUTSET",this._selectionModel())}},"SINGLE-COLUMN":{buttonHTML:function(){return"S"},isVisible:function(){return this._allMediaBlocks()},buttonClass:function(){return this._allLayoutsAre("SINGLE-COLUMN")?this.BUTTON_ACTIVE_CLASS_NAME:null},onClick:function(){this._model.setLayout("SINGLE-COLUMN",this._selectionModel())}},"FULL-WIDTH":{buttonHTML:function(){return"F"},isVisible:function(){return this._allMediaBlocks()},buttonClass:function(){return this._allLayoutsAre("FULL-WIDTH")?this.BUTTON_ACTIVE_CLASS_NAME:null},onClick:function(){this._model.setLayout("FULL-WIDTH",this._selectionModel())}}},init:function(a){this._super(a),this._editor=a.editor,this.on("changed",this._selection().model(),this._onSelectionChanged.bind(this)),this.on("changed",this._model,this._onDocumentChanged.bind(this)),this._render()},_onSelectionChanged:function(){this._selectionModel().isRange()||this._selectionModel().isMedia()?(this._showAndPosition(),this._updateButtonStates()):this._hide()},_onDocumentChanged:function(){(this._selectionModel().isRange()||this._selectionModel().isMedia())&&this._updateButtonStates()},_render:function(){this._el=document.createElement("div"),this._el.className=this.CLASS_NAME;for(var a in this.BUTTONS)if(this.BUTTONS.hasOwnProperty(a)){var b=document.createElement("button");b.type="button",b.innerHTML=this.BUTTONS[a].buttonHTML(),b.setAttribute("data-action",a),this.on("click",b,this.BUTTONS[a].onClick.bind(this)),this._el.appendChild(b)}},_showAndPosition:function(){var a=this._selection().rectangle(),b=this._el.cloneNode(!0);b.style.visibility="hidden",this._el.parentNode.appendChild(b),b.className=[this.CLASS_NAME,this.ACTIVE_CLASS_NAME].join(" ");var c=b.offsetWidth,d=b.offsetHeight;b.parentNode.removeChild(b);var e=(a.right+a.left-c)/2,f=a.top-d;classNames=[this.CLASS_NAME,this.ACTIVE_CLASS_NAME],a.clientTop<d&&(f=a.bottom,classNames.push(this.POSITION_UNDER_CLASS_NAME)),this._el.style.top=f+"px",this._el.style.left=e+"px",this._el.className=classNames.join(" ")},_updateButtonStates:function(){for(var a=0;a<this._el.childNodes.length;a++){var b=this._el.childNodes[a],c=b.dataset.action;b.style.display=this.BUTTONS[c].isVisible.bind(this)()?"inline-block":"none",b.className=this.BUTTONS[c].buttonClass.bind(this)()}},_hide:function(){this._el.className=this.CLASS_NAME},_selection:function(){return this._editor.selection()},_selectionModel:function(){return this._selection().model()},_allBlocksSupportMarkup:function(a){return this._allBlocks(function(b){return b.supportsMarkupType(a)})},_markedUpAs:function(a){var b=this._selectionModel();return this._allBlocks(function(c,d){var e=d==b.startIx()?b.startOffset():0,f=d==b.endIx()?b.endOffset():c.text().length;return c.isRangeMarkedUpAs(a,e,f)})},_noMediaBlocks:function(){return this._allBlocks(function(a){return!a.isMedia()})},_allMediaBlocks:function(){return this._allBlocks(function(a){return a.isMedia()})},_allBlockQuotes:function(){return this._allBlocks(function(a){return a.isQuote()&&"SINGLE-COLUMN"==a.layout()})},_allPullQuotes:function(){return this._allBlocks(function(a){return a.isQuote()&&"PULL-QUOTE"==a.layout()})},_allBlocksAre:function(a){return this._allBlocks(function(b){return b.type()==a})},_allLayoutsAre:function(a){return this._allBlocks(function(b){return b.layout()==a})},_allBlocks:function(a){for(var b=this._selectionModel().startIx();b<=this._selectionModel().endIx();b++)if(!a.bind(this)(this._model.blocks().at(b),b))return!1;return!0}}),MediumEditor.SelectionView=MediumEditor.View.extend({SELECTED_MEDIA_CLASS:"medium-editor-media-selected",init:function(a){this._super(a),this._editor=a.editor,this.on("changed",this._model,this._onSelectionChanged.bind(this))},_onSelectionChanged:function(a,b){b!=this&&this.setOnBrowser(),this.updateMediaSelections()},rectangle:function(){return this._rectangle},startBlockElement:function(){return MediumEditor.ModelDOMMapper.getBlockElementFromIndex(this._document()._el,this._model._startIx)},endBlockElement:function(){return MediumEditor.ModelDOMMapper.getBlockElementFromIndex(this._document()._el,this._model._endIx)},updateMediaSelections:function(){var a=this._editor._el.querySelector("."+this.SELECTED_MEDIA_CLASS);a&&(a.className=a.className.replace(new RegExp(this.SELECTED_MEDIA_CLASS,"g"),"")),this._model.isMedia()&&(this.startBlockElement().className+=" "+this.SELECTED_MEDIA_CLASS)},setOnBrowser:function(){if(this._model.isNull())this.deselect();else{var a;if(document.createRange&&window.getSelection){a=document.createRange();var b=window.getSelection(),c=MediumEditor.ModelDOMMapper.modelSpaceToDOMSpace(this._document()._el,this._model._startIx,this._model._startOffset),d=MediumEditor.ModelDOMMapper.modelSpaceToDOMSpace(this._document()._el,this._model._endIx,this._model._endOffset);a.setStart(c.node,c.offset),a.setEnd(d.node,d.offset),this._model.isCaret()&&a.collapse(!0),b.removeAllRanges(),b.addRange(a)}else document.selection&&document.body.createTextRange&&(a=document.body.createTextRange(),a.moveToElementText(MediumEditor.ModelDOMMapper.getBlockElementFromIndex(this._document()._el,this._model._startIx)),a.collapse(!0),a.moveEnd("character",this._model._startOffset),a.moveStart("character",this._model._startOffset),a.select());this._updateRectangle(a)}},determineFromBrowser:function(a){"undefined"==typeof a&&(a={}),a.caller=this;var b,c,d,e,f;if(window.getSelection){var g=window.getSelection();"none"!=g.type.toLowerCase()&&(f=g.getRangeAt(0),b=f.startContainer,c=f.startOffset,d=f.endContainer,e=f.endOffset)}else if(document.selection){var g=document.selection;f=g.createRange();var h=this._ieSelectionInfo(f,"start"),i=this._ieSelectionInfo(f,"end");b=h.node,c=h.offset,d=i.node,e=i.offset}if(!b)return void this._model["null"]();if(!this._isWithinDocument(b)||b==this._document()._el)return void this._model["null"]();var j=MediumEditor.ModelDOMMapper.domSpaceToModelSpace(b,c,f,!0),k=MediumEditor.ModelDOMMapper.domSpaceToModelSpace(d,e,f,!1);this._updateRectangle(f),this._model.set({startIx:j.ix,startOffset:j.offset,endIx:k.ix,endOffset:k.offset},a)},deselect:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},_updateRectangle:function(a){var b=a.getBoundingClientRect();if(0==b.height&&0==b.width){var c=a.startContainer;(3==c.nodeType||"BR"==c.tagName)&&(c=c.parentNode),b=c.getBoundingClientRect()}var d=this._document()._el.getBoundingClientRect(),e=b.top-d.top,f=b.bottom-d.top,g=b.left-d.left,h=b.right-d.left;this._rectangle={top:e,left:g,bottom:f,right:h,clientTop:b.top,clientLeft:b.left,clientBottom:b.bottom,clientRight:b.right}},_isWithinDocument:function(a){return this._document()._el==a?!0:a.parentNode&&1==a.parentNode.nodeType?this._isWithinDocument(a.parentNode):!1},_ieSelectionInfo:function(a,b){if(!a)return null;b=b.toLowerCase();var c=a.duplicate(),d=a.duplicate();c.collapse("start"==b);var e=c.parentElement();return e instanceof HTMLInputElement?null:(d.moveToElementText(e),d.setEndPoint("EndToEnd",c),this._ieFindTextNode(e.firstChild,d.text))},_ieFindTextNode:function(a,b){do if(3==a.nodeType){var c=a.nodeValue;if(!(b.length>0&&0===b.indexOf(c)&&b!==c))return{node:a,offset:b.length};b=b.substring(c.length)}else if(1===a.nodeType){var d=document.body.createTextRange();d.moveToElementText(a),b=b.substring(d.text.length)}while(a=a.nextSibling);return null},_document:function(){return this._editor.document()}}),MediumEditor.EditorView=MediumEditor.View.extend({init:function(a){this._super(a),this._el=document.createElement("div"),this._el.className="medium-editor",this._selectionModel=new MediumEditor.SelectionModel({document:this._model}),this._selection=new MediumEditor.SelectionView({model:this._selectionModel,editor:this}),this._document=new MediumEditor.DocumentView({model:this._model,editor:this}),this._el.appendChild(this._document.el()),this._inlineTooltip=new MediumEditor.InlineTooltipMenuView({model:this._model,editor:this}),this._el.appendChild(this._inlineTooltip.el()),this._highlightMenu=new MediumEditor.HighlightMenuView({model:this._model,editor:this}),this._el.appendChild(this._highlightMenu.el()),this.on("keyup",this._document.el(),this._onKeyUp.bind(this)),this.on("keydown",this._document.el(),this._onKeyDown.bind(this)),this.on("mouseup",document,this._onMouseUp.bind(this)),this.on("paste",this._document.el(),this._onPaste.bind(this)),this.on("mousedown",this._document._el,this._onMouseDown.bind(this))},_onKeyUp:function(){this._selection.determineFromBrowser({triggerEvent:!1});var a=this._selectionModel.startBlock(),b=this._selection.startBlockElement().innerText;"\n"==b&&(b=""),a.isParagraph()&&b.match(/^1\.\s/)?(a.setType("ORDERED_LIST_ITEM",{text:b.substring(3)}),this._selectionModel.caret(this._selectionModel.startIx(),0,{triggerEvent:!1})):a.isParagraph()&&b.match(/^\*\s/)?(a.setType("UNORDERED_LIST_ITEM",{text:b.substring(2)}),this._selectionModel.caret(this._selectionModel.startIx(),0,{
triggerEvent:!1})):a.setText(b),this._selectionModel.trigger("changed",this._selectionModel,this._selection)},_onKeyDown:function(a){{var b=this._selectionModel.startBlock();this._selectionModel.endBlock()}switch(a.which){case 66:case 73:a.metaKey&&(this._selectionModel.isRange()&&this._model.toggleMarkup(66==a.which?"STRONG":"EMPHASIS",this._selectionModel),a.preventDefault());break;case 8:if(this._selectionModel.isMedia())b.setType("PARAGRAPH"),a.preventDefault();else if(this._selectionModel.isRange())this._selectionModel.spansBlocks()&&(this._removeSelectedText(),a.preventDefault());else if(this._selectionModel.isCaret()){var c=this._model.blocks().at(this._selectionModel.startIx()-1);if(b.isListItem()&&0==this._selectionModel.startOffset())b.setType("PARAGRAPH"),a.preventDefault();else if(0==this._selectionModel.startIx()&&0==this._selectionModel.startOffset())b.isEmpty()&&!b.isParagraph()&&b.setType("PARAGRAPH"),a.preventDefault();else if(0==this._selectionModel.startOffset()&&c.isDivider())this._model.removeBlockAt(this._selectionModel.startIx()-1),this._selectionModel.set(this._selectionModel.startIx()-1,0),a.preventDefault();else if(0==this._selectionModel.startOffset()&&c.isMedia())this._selectionModel.media(this._selectionModel.startIx()-1),a.preventDefault();else if(0==this._selectionModel.startOffset()&&c.isParagraph()&&c.isEmpty())this._selectionModel.caret(this._selectionModel.startIx()-1,0),this._model.removeBlockAt(this._selectionModel.startIx()),a.preventDefault();else if(0==this._selectionModel.startOffset()){var d=c.text(),e=d+b.text();c.setText(e),this._selectionModel.caret(this._selectionModel.startIx()-1,d.length),this._model.removeBlockAt(this._selectionModel.startIx()+1),a.preventDefault()}}break;case 77:if(!a.ctrlKey)break;case 13:if(this._selectionModel.isRange()&&this._removeSelectedText({clearIfParagraphSelection:!0}),this._selectionModel.isCaret()&&b.isListItem()&&b.isEmpty())b.setType("PARAGRAPH"),a.preventDefault();else if(0==this._selectionModel.startOffset())this._model.insertBlockAt(b.isListItem()?b.type():"PARAGRAPH",this._selectionModel.startIx()),this._selectionModel.caret(this._selectionModel.startIx()+1,0),a.preventDefault();else{var f=b.text(),g=f.substring(0,this._selectionModel.startOffset()),h=f.substring(this._selectionModel.endOffset()),i=""!=h||b.isListItem()?b.type():"PARAGRAPH";this._model.insertBlockAt(i,this._selectionModel.startIx()+1,{text:h}),b.setText(g),this._selectionModel.caret(this._selectionModel.startIx()+1,0),a.preventDefault()}break;default:var j=[9,16,17,18,19,20,27,33,34,35,36,37,38,39,40,45,91,92,93];this._selectionModel.isRange()&&this._selectionModel.spansBlocks()&&j.indexOf(a.which)<0&&this._removeSelectedText({clearIfParagraphSelection:!0})}},_removeSelectedText:function(a){if(a="undefined"==typeof a?{}:a,a.clearIfParagraphSelection=!!a.clearIfParagraphSelection,this._selectionModel.isRange()){var b=this._selectionModel.startBlock(),c=this._selectionModel.endBlock(),d=this._selectionModel.startIx(),e=this._selectionModel.endIx(),f=this._selectionModel.startOffset(),g=this._selectionModel.endOffset();a.clearIfParagraphSelection&&e==d+1&&0==g&&(e=d,g=b.text().length,c=b);var h=b.text().substr(0,f);h+=c.text().substr(g),b.setText(h),this._selectionModel.caret(d,f);for(var i=e;i>d;i--)this._model.removeBlockAt(i)}},_onMouseUp:function(){setTimeout(function(){this._selection.determineFromBrowser()}.bind(this),10)},_onMouseDown:function(a){if("img"==a.target.tagName.toLowerCase()&&"figure"==a.target.parentNode.tagName.toLowerCase()){var b=a.target.parentNode,c=MediumEditor.ModelDOMMapper.getIndexFromBlockElement(b);this._selection.model().media(c)}},_onPaste:function(a){if(a.preventDefault(),a&&a.clipboardData&&a.clipboardData.getData&&/text\/plain/.test(a.clipboardData.types)){for(var b=a.clipboardData.getData("text/plain"),c=b.split("\n"),d=[],e=0;e<c.length;e++){var f=c[e];""!=f&&null!=f&&d.push(f)}for(var e=0;e<d.length;e++){var f=d[e];if(0==e){var g=this._selectionModel.startBlock();g.setText(g.text()+f)}else this._model.insertBlockAt("PARAGRAPH",this._selectionModel.startIx()+1+e,{text:f})}this._selection.model().caret(this._selectionModel.startIx()+d.length-1,d[d.length-1].length)}},selection:function(){return this._selection},document:function(){return this._document}}),MediumEditor.DocumentView=MediumEditor.View.extend({CLASS_NAME:"medium-editor-document",BLANK_CLASS_NAME:"medium-editor-document-blank",init:function(a){this._super(a),this._editor=a.editor,this._el=document.createElement("div"),this._el.className="medium-editor-document",this._el.contentEditable=!0,this.on("changed",this._model,this._onChanged.bind(this)),this._render()},_onChanged:function(){this._render(),this._editor.selection().setOnBrowser()},_render:function(){this._el.innerHTML=MediumEditor.ModelDOMMapper.toHTML(this._model),this._el.className=[this.CLASS_NAME,this._model.isBlank()?this.BLANK_CLASS_NAME:""].join(" ")}}),MediumEditor.prototype={init:function(a){if(!this._supportedPlatform())return!1;if(this._el="string"==typeof a||a instanceof String?document.querySelector(a):a,!this._el)return!1;this._el.style.display="none";var b="";b="textarea"==this._el.tagName.toLowerCase()?this._el.value:this._el.innerHTML,this._documentModel=new MediumEditor.DocumentModel({html:b}),"textarea"==this._el.tagName.toLowerCase()&&this._documentModel.on("changed",this._onDocumentChanged.bind(this)),this._editorView=new MediumEditor.EditorView({model:this._documentModel}),this._el.parentNode.insertBefore(this._editorView._el,this._el)},_onDocumentChanged:function(){this._el.value=MediumEditor.ModelDOMMapper.toHTML(this._documentModel)},_supportedPlatform:function(){return this._querySelectorSupported()&&this._contentEditableSupported()},_querySelectorSupported:function(){return"querySelector"in document&&"querySelectorAll"in document},_contentEditableSupported:function(){if(!("contentEditable"in document.body))return!1;var a=document.createElement("div");return a.contentEditable=!0,"true"===a.contentEditable}};